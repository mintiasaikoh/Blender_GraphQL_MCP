# Blender Unified MCP 要件定義書

## 1. 概要

### 1.1 目的
Blender Unified MCPは、LLM（大規模言語モデル）がBlenderと効率的かつ堅牢に通信するためのインターフェースを提供するBlenderアドオンです。MCPプロトコルを通じて、LLMはBlenderの3Dモデリング機能を活用し、ユーザーの自然言語指示を3Dコンテンツに変換できます。

### 1.2 参考プロジェクト
本プロジェクトは[ahujasid/blender-mcp](https://github.com/ahujasid/blender-mcp)のコンセプトを参考にしました。

### 1.3 スコープ
- Blender内部でのHTTPサーバー実装
- JSONベースのコマンドインターフェース
- 詳細なコンテキスト報告機能
- 操作結果検証と問題診断機能
- ブーリアンなどの複雑操作の堅牢化

## 2. 機能要件

### 2.1 コアシステム

#### 2.1.1 HTTPサーバー機能
- Blender内部でHTTPサーバーを起動・管理
- JSONリクエスト/レスポンス形式の通信
- 非同期処理によるレスポンシブな操作
- セキュリティ対策（ローカルホストのみの接続許可など）

#### 2.1.2 MCPプロトコル実装
- RESTful APIエンドポイント設計
- JSONスキーマによるリクエスト検証
- バッチ処理とコマンドグループ化
- エラーハンドリングと詳細な診断情報

### 2.2 コマンドインターフェース

#### 2.2.1 統合コマンド実行
- 単一エンドポイントからすべてのBlender操作を実行可能
- 構造化されたJSONコマンド形式
- 操作の事前検証と自動修復オプション
- 詳細な結果報告と変更検出

#### 2.2.2 高レベル操作
- 一般的な3Dモデリングタスクのための抽象化されたコマンド
- 複数の基本操作を組み合わせた複合コマンド
- パラメトリックなオブジェクト生成
- シーン全体の構造操作（部屋、家具などの配置）

#### 2.2.3 メッシュ操作
- 基本形状の作成と編集
- ブーリアン操作（和集合、差集合、交差）の堅牢な実装
- メッシュの分析と修復
- 細分化、デシメート、リメッシュなどの処理

### 2.3 コンテキスト取得

#### 2.3.1 シーン情報
- シーン内のオブジェクト一覧と階層
- メタデータ（作者、日付、単位など）
- レンダリング設定
- アニメーション情報

#### 2.3.2 オブジェクト詳細
- ジオメトリ情報（頂点数、面数など）
- マテリアルと質感
- 変換情報（位置、回転、スケール）
- モディファイアとその設定

#### 2.3.3 空間分析
- オブジェクト間の相対位置関係
- 空間占有情報（占有グリッド）
- シーンの境界と中心
- 衝突検出と干渉チェック

#### 2.3.4 メッシュ品質分析
- トポロジー情報（クワッド、トライ、Nゴン数）
- 非マニフォールド要素の検出
- UVマップの品質と使用状況
- 最適化提案

### 2.4 結果検証と診断

#### 2.4.1 操作結果検証
- 操作前後の状態比較
- メッシュ整合性チェック
- 期待された変更の確認
- パフォーマンス影響の評価

#### 2.4.2 エラー診断
- 詳細なエラー情報と原因特定
- 操作失敗時の代替提案
- メッシュ問題の視覚化情報
- 修復手順の提案

## 3. 具体的なユースケース

### 3.1 基本的なモデリング
- LLMが「5m x 4m x 3mの部屋を作成」という指示を解釈
- MCPを通じて適切なBlenderコマンドを実行
- 結果を検証し、成功/失敗をLLMに報告

### 3.2 複雑なブーリアン操作
- 「立方体から球を差し引く」という操作
- 事前にメッシュの問題を検出して修復
- ブーリアン操作を実行し、結果の品質を評価
- 詳細な変更レポートをLLMに返す

### 3.3 シーン分析
- 「現在のシーンで最も大きなオブジェクトを特定」
- MCPがシーン内のすべてのオブジェクトを分析
- サイズと位置関係に基づいて結果を返す
- LLMが分析結果を人間が理解できる形で説明

## 4. 技術要件

### 4.1 Blender互換性
- Blender 4.0以上をサポート
- Python 3.10以上
- アドオンとしての適切な統合
- Blender APIの適切な使用

### 4.2 HTTPサーバー実装
- FastAPIまたは同等のフレームワークの使用
- 非同期処理のサポート
- WebSocket（オプション）による双方向通信
- リクエスト/レスポンスのJSON形式

### 4.3 エラーハンドリング
- 堅牢なエラー捕捉と報告
- 操作の安全な中断と回復
- ユーザーフレンドリーなエラーメッセージ
- デバッグ情報の提供

### 4.4 パフォーマンス
- 大規模シーンでの応答性
- メモリ効率の良い実装
- 長時間操作の進捗報告
- リソース使用量の最適化

## 5. APIエンドポイント仕様

### 5.1 コマンド実行
```
POST /blender/command
```
ペイロード例:
```json
{
  "command": "boolean",
  "operation": "difference",
  "target": "Cube",
  "cutter": "Sphere",
  "options": {
    "auto_repair": true,
    "pre_validate": true,
    "solver": "exact"
  }
}
```

### 5.2 コンテキスト取得
```
GET /blender/context?detail_level=standard
GET /blender/object/{name}
GET /blender/material/{name}
GET /blender/analyze
```

### 5.3 状態比較
```
POST /blender/compare
```
ペイロード例:
```json
{
  "before_state": {...},
  "after_state": {...},
  "focus_on": ["geometry", "materials"]
}
```

## 6. 実装方針

### 6.1 コード構造
- クラスベースの整理された実装
- 機能ごとにモジュール分割
- 単一責任の原則に基づく設計
- 拡張性を考慮したインターフェース設計

### 6.2 開発アプローチ
- 一度に完全な再設計を実施
- 互換性よりも設計の美しさと機能性を優先
- 堅牢なテストケースの作成
- 詳細なドキュメントの整備

## 7. 将来の拡張性

### 7.1 考えられる拡張
- リアルタイムレンダリング結果の提供
- 外部AIシステムとの連携（NeRF、画像生成など）
- 複数ユーザーによる協調編集
- VR/ARインターフェースとの連携

### 7.2 API拡張性
- バージョン管理されたAPI
- プラグイン機構による機能拡張
- カスタムコマンドの定義
- サードパーティツールとの統合

## 8. システム構成図

```
+------------------+        +----------------+
|                  |        |                |
|  LLM System      |<------>|  MCP HTTP     |
|  (ChatGPT等)     |  JSON  |  Server       |
|                  |        |                |
+------------------+        +-------+--------+
                                   |
                                   | Blender Python API
                                   v
                           +----------------+
                           |                |
                           |  Blender       |
                           |  3Dエンジン    |
                           |                |
                           +----------------+
```

この要件定義書は、個人開発プロジェクトとしての性質を考慮し、段階的な移行ではなく一度に完全な再設計を行うことを前提としています。ahujasid/blender-mcpのコンセプトを参考にしつつ、より包括的で堅牢なシステムを目指します。

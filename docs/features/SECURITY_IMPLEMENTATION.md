# Blender GraphQL MCP セキュリティ実装

## 目次

1. [概要](#概要)
2. [主要コンポーネント](#主要コンポーネント)
3. [統合状況](#統合状況)
4. [統合ステップ](#統合ステップ)
5. [セキュリティリスク評価](#セキュリティリスク評価)
6. [将来の改善点](#将来の改善点)

## 概要

Blender GraphQL MCPプロジェクトのセキュリティを大幅に強化するため、複数の重要なコンポーネントを実装しました。最も重要な変更点は、危険な`exec()`関数の使用を排除し、安全なコマンドパターンとスクリプト検証システムを導入したことです。これにより、コードインジェクション攻撃のリスクを大幅に低減しました。

**主な成果**:
- 危険な`exec()`関数の排除
- デコレータベースの安全なコマンド登録・実行システム
- AST解析によるスクリプト検証
- 後方互換性を維持しながらの安全な実装への移行

## 主要コンポーネント

### 1. 安全なコマンドハンドラー

**ファイル**: `/core/commands/secure_command_handler.py`  
**ステータス**: ✅ 完了

デコレータベースのコマンド登録システムを実装し、事前に登録されたコマンドのみを実行できるようにしました。パラメータの検証や型チェックも自動的に行われます。

**旧実装の問題点**:
元の実装では、クライアントから送信されたコード文字列を直接`exec()`関数で実行していました。これはコードインジェクション攻撃の重大なリスクを作り出していました。

```python
# 危険な実装例
def execute_command(command: str) -> Dict[str, Any]:
    # ...
    exec(command, {"bpy": bpy}, locals_dict)
    # ...
```

**新実装のアプローチ**:
デコレータベースのコマンド登録システムを導入し、事前に定義された安全な関数のみを実行できるようにしました。

```python
# 安全な実装例
@register_command("select_object", "Blenderオブジェクトを選択")
def select_object(object_name: str, deselect_others: bool = True) -> Dict[str, Any]:
    # 安全に実装されたオブジェクト選択機能
    # ...
```

主な機能:
- `@register_command`デコレータによるコマンド登録
- パラメータ検証と型チェック
- 安全な実行環境
- 基本コマンド（オブジェクト選択、プリミティブ作成など）の実装

### 2. 安全なスクリプト実行システム

**ファイル**: `/core/utils/safe_script_executor.py`  
**ステータス**: ✅ 完了

Python ASTを使用してスクリプトの安全性を検証し、危険な操作（ファイルI/O、システムコマンド実行など）を検出・防止するシステムを実装しました。

主な機能:
- AST解析による危険な操作の検出
- 禁止されたモジュールと関数のブロック
- 実行時間の制限
- 制限された実行環境

```python
class ScriptValidator:
    """安全なスクリプト実行のためのバリデータ"""
    # 禁止されたモジュール
    FORBIDDEN_MODULES = {
        'os', 'subprocess', 'sys', 'shutil', 'pathlib', 
        'socket', 'urllib', 'http', 'ftplib', 'poplib', 
        'smtplib', 'telnetlib'
    }
    
    # 禁止された組み込み関数
    FORBIDDEN_BUILTINS = {
        'exec', 'eval', 'compile', '__import__', 
        'open', 'input', 'breakpoint'
    }
```

### 3. 安全なAPIハンドラー

**ファイル**: `/core/api_handlers_secure.py`  
**ステータス**: ✅ 完了

危険な`exec()`を使用していた元のAPIハンドラーを、安全なコマンドパターンを使用する実装に置き換えました。

主な変更点:
- `exec()`の削除
- 安全なコマンドハンドラーの使用
- エラー処理の強化
- イベント駆動型の非同期処理

### 4. 安全なメタコマンド

**ファイル**: `/core/meta_commands_secure.py`  
**ステータス**: ✅ 完了

メタコマンド（バッチ実行、シーン分析など）を安全なコマンドパターンを使用するよう再実装しました。

主な変更点:
- 全関数を`@register_command`デコレータで登録
- パラメータの明示的な型アノテーション
- 戻り値の標準化
- `exec()`の排除

### 5. 安全なコード実行

**ファイル**: `/core/secure_code_executor.py`  
**ステータス**: ✅ 完了

AST検証に基づく安全なコード実行システムを実装し、`execute_code`コマンドを更新しました。

主な機能:
- AST解析によるコードの安全性検証
- 実行時間の制限
- 制限された実行環境
- JSON互換性の確保

### 6. 安全なスクリプト実行演算子

**ファイル**: `/operators/execute_script_secure.py`  
**ステータス**: ✅ 完了

Blender演算子を更新して、安全なスクリプト実行システムを使用するようにしました。

主な変更点:
- AST解析による安全性検証の組み込み
- エラー処理の強化
- 実行時間の制限
- セキュリティ検証のスキップオプション（開発用）

## 統合状況

### 基本コンポーネントの統合

| コンポーネント | 元のファイル | 安全な実装 | 統合状況 |
|-------------|------------|---------|---------|
| APIハンドラー | `/core/api_handlers.py` | `/core/api_handlers_secure.py` | ✅ 完了 |
| メタコマンド | `/core/meta_commands.py` | `/core/meta_commands_secure.py` | ✅ 完了 |
| スクリプト実行 | `/operators/execute_script.py` | `/operators/execute_script_secure.py` | ✅ 完了 |
| コード実行 | - | `/core/secure_code_executor.py` | ✅ 完了 |

### インポートと参照の更新

| ファイル | 変更内容 | 統合状況 |
|---------|---------|---------|
| `/core/__init__.py` | セキュアな実装を優先的にインポート | ✅ 完了 |
| `/operators/__init__.py` | セキュアな実装を優先的にインポート | ✅ 完了 |
| `/core/command_handler.py` | 安全なコマンドシステムを使用 | ✅ 完了 |
| `/core/http_server.py` | メタコマンドの参照更新 | ⬜ 未完了 |

### 後方互換性

| 機能 | 実装状況 |
|-----|---------|
| 古いコマンド形式のサポート | ✅ 完了 |
| 新形式・旧形式の変換 | ✅ 完了 |
| フォールバック機能 | ✅ 完了 |
| 警告ログ | ✅ 完了 |

## 統合ステップ

### 基本モジュールの置き換え

以下のファイルを安全な実装に置き換える必要があります：

- ✅ `/core/api_handlers.py` → `/core/api_handlers_secure.py`
- ✅ `/core/meta_commands.py` → `/core/meta_commands_secure.py`
- ✅ `/operators/execute_script.py` → `/operators/execute_script_secure.py`

### セキュリティコンポーネントの確認

以下のセキュリティコンポーネントが正しく配置されていることを確認：

- ✅ `/core/commands/secure_command_handler.py`
- ✅ `/core/utils/safe_script_executor.py`
- ✅ `/core/secure_code_executor.py`

### インポートと参照の更新

以下のファイルのインポート文を更新する必要があります：

- ✅ `/core/__init__.py`: メタコマンドのインポート文を安全な実装に更新
- ✅ `/operators/__init__.py`: 安全なスクリプト実行演算子を登録
- ✅ `/core/command_handler.py`: 安全な実装へのリファレンスを更新
- ⬜ `/core/http_server.py`: 必要に応じてメタコマンドの参照を更新

### 後方互換性の確保

安全な実装に移行しながら、後方互換性を維持するために：

1. ✅ 古いコマンド形式をサポートするためのラッパー関数を実装
   - command_handler.pyの`handle_command`関数で両方の形式に対応
   - 変換ロジックを実装して新旧形式の相互運用性を確保
2. ✅ 非推奨の警告を追加して、開発者に安全なAPIの使用を促進
   - ログメッセージで安全な実装の使用を促進
3. ✅ 安全な実装へのリダイレクトを提供
   - フォールバック機能を実装して、エラー時は従来の実装を使用

## セキュリティリスク評価

| リスク | 旧実装 | 新実装 | 軽減策 |
|-------|-------|-------|-------|
| コードインジェクション | 高 | 低 | コマンドパターン、AST検証 |
| 無限ループによるDOS | 高 | 低 | 実行時間の制限 |
| ファイルシステムアクセス | 高 | 低 | 禁止モジュールのブロック |
| システムコマンド実行 | 高 | 低 | 禁止操作のブロック |
| 危険なBlender API使用 | 中 | 低 | 制限されたBPYアクセス |

## 将来の改善点

1. ⬜ コンテナ化とサンドボックス化による追加のセキュリティレイヤー
2. ⬜ 権限ベースのコマンド実行とユーザー認証
3. ⬜ コードの静的解析とセキュリティスキャンの統合
4. ⬜ セキュリティ監査ログとモニタリングの追加

## 次のステップ

- ✅ `/core/meta_commands.py`を安全な実装で更新
- ✅ `/operators/execute_script.py`を安全な実装で更新
- ✅ インポートと参照を更新
- ⬜ 統合をテスト
- ⬜ ドキュメントを更新して安全なAPIの使用法を説明
- ⬜ デプロイメントガイドを更新

## 注意事項

- 安全な実装と従来の実装が共存していますが、安全な実装が優先的に使用されます
- エラー時には従来の実装にフォールバックするため、後方互換性は維持されています
- 開発者は新しいコマンド形式（`command`と`params`の分離）を使用することが推奨されます